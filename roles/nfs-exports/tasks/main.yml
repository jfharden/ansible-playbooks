---
- name: Install nfs-kerner-server
  become: true
  ansible.builtin.apt:
    name: nfs-kernel-server
    state: present
    update_cache: true
    cache_valid_time: 3600
  notify:
    - Reload nfs exports

- name: Create any directories needed on local disk
  become: true
  when: "{{ item.create_dir }}"
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    mode: "0770"
    owner: "{{ item.create_as_user }}"
    group: "{{ item.create_as_group }}"
  loop: "{{ remotes_to_export }}"

- name: Enable and start nfs-kernel-server
  become: true
  ansible.builtin.service:
    name: nfs-kernel-server
    enabled: true
    state: started
  notify:
    - Reload nfs exports

- name: Ensure export configuration exists
  become: true
  ansible.builtin.blockinfile:
    dest: /etc/exports
    marker: "# {mark} ANSIBLE MANAGED BLOCK FOR {{ item.path }} {{ item.export_to }}"
    content: "{{ item.path }} {{ item.export_to }}({{ item.mode }},sync,no_subtree_check,all_squash,anonuid={{ item.anon_uid }},anongid={{ item.anon_gid }},insecure)"
    backup: true
  loop: "{{ remotes_to_export }}"
  notify:
    - Reload nfs exports
